<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
   <script>
   const getUserIP= (onNewIP)=> {
  let MyPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
  let pc = new MyPeerConnection({
    iceServers: []
  });
  let noop = () => {
  };
  let localIPs = {};
  let ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g;
  let iterateIP = (ip) => {
    if (!localIPs[ip]) onNewIP(ip);
    localIPs[ip] = true;
  };
  pc.createDataChannel('');
  pc.createOffer().then((sdp) => {
    sdp.sdp.split('\n').forEach(function (line) {
      if (line.indexOf('candidate') < 0) return;
      line.match(ipRegex).forEach(iterateIP);
    });
    pc.setLocalDescription(sdp, noop, noop);
  }).catch((reason) => {
  });
  pc.onicecandidate = (ice) => {
    if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
    ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
  };
}
 
 
 
 var state = {
    
 }
  getUserIP((ip) => {
   state.ip=ip
      console.log(ip)
      console.log(state.ip)
  });

//二：
// if(typeof window != 'undefined'){
//     var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;

//     if (RTCPeerConnection) (()=>{
//         var rtc = new RTCPeerConnection()

//         rtc.createDataChannel(''); //创建一个可以发送任意数据的数据通道

//         rtc.createOffer( offerDesc => { //创建并存储一个sdp数据

//         rtc.setLocalDescription(offerDesc)

//     }, e => { console.log(e)})

//     rtc.onicecandidate =(evt) => { //监听candidate事件

//         if (evt.candidate) {
//             console.log('evt:',evt.candidate)

//             let ip_rule = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/

//             var ip_addr = ip_rule.exec(evt.candidate.candidate)[1]

//             console.log('ip_addr:',ip_addr)   //打印获取的IP地址

//         }}

//     })()

//     else{console.log("没有找到")}
// }
   </script>
</body>
</html>